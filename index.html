<!DOCTYPE html>
<html lang="en">

<head>
    <title>MIDItoOSU</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/style.css" />

    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/functions.js"></script>
</head>


<body>
    <header>
        <div id="header-content">
            <h1>MIDItoOSU</h1>
            <p>A MIDI to osu!mania 10k beatmap converter</p>
        </div>
    </header>


    <main>
        <form action="php/convert.php" method="post">
            <div class="row">
                <div class="col" id="main-content-1">
                    <div class="form-group">
                        <label for="midi"><b>Upload a MIDI file:</b></label>
                        <label for="midi" class="form-control" id="choose-midi">
                            Drag & Drop or click here to browse for a file
                        </label>
                        <input type="file" accept=".mid" id="midi" name="midi" hidden />
                    </div>

                    <div class="form-group">
                        <label id="tracks-label"><b>Tracks:</b></label>
                        <div id="tracks">
                            <table class="table table-borderless" id="tracks-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Lefthand</th>
                                        <th>Righthand</th>
                                        <th>Background</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="track-row" id="track-1">
                                        <td>Track 1</td>
                                        <td>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input"
                                                    id="track-1-lefthand" name="track-1-lefthand">
                                                <label class="custom-control-label" for="track-1-lefthand"></label>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input"
                                                    id="track-1-righthand" name="track-1-righthand">
                                                <label class="custom-control-label" for="track-1-righthand"></label>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input"
                                                    id="track-1-background" name="track-1-background">
                                                <label class="custom-control-label" for="track-1-background"></label>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr id="track-1-options-1" hidden>
                                        <td>
                                            <input type="button" class="form-control track-preview" value="play"
                                                id="track-1-preview" />
                                        </td>
                                        <td>
                                            <select class="form-control track-sound" id="track-1-sound"
                                                name="track-1-sound">
                                                <option value="Custom">Add custom sound</option>
                                                <option value="Piano 1" selected>Piano 1</option>
                                                <option value="Piano 2">Piano 2</option>
                                                <option value="Piano 3">Piano 3</option>
                                                <option value="Violin 1">Violin 1</option>
                                                <option value="Violin 2">Violin 2</option>
                                                <option value="Trumpet">Trumpet</option>
                                            </select>
                                        </td>
                                        <td colspan="2">
                                            <div class="row">
                                                <div class="col-md-12 text-center">
                                                    <span id="track-1-volume-value">100</span>
                                                </div>
                                            </div>
                                            <div class="row range-div">
                                                <div class="col-md-2">
                                                    <span>No sound</span>
                                                </div>
                                                <div class="col-md-8">
                                                    <input type="range" class="custom-range track-volume" min="0"
                                                        max="200" step="5" value="100" id="track-1-volume"
                                                        name="track-1-volume">
                                                </div>
                                                <div class="col-md-2">
                                                    <span>200</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr id="track-1-options-2" hidden>
                                        <td colspan="4">
                                            <div class="row">
                                                <div class="col-md-12 text-center">
                                                    <span id="track-1-timebar-value">0</span>
                                                </div>
                                            </div>
                                            <div class="row range-div">
                                                <div class="col-md-2">
                                                    <span>0</span>
                                                </div>
                                                <div class="col-md-8">
                                                    <input type="range" class="custom-range track-timebar" min="0"
                                                        max="180" step="1" value="0" id="track-1-timebar">
                                                </div>
                                                <div class="col-md-2">
                                                    <span>180</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>

                                    <tr class="track-row" id="track-2">
                                        <td>Track 2</td>
                                        <td>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input"
                                                    id="track-2-lefthand" name="track-2-lefthand">
                                                <label class="custom-control-label" for="track-2-lefthand"></label>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input"
                                                    id="track-2-righthand" name="track-2-righthand">
                                                <label class="custom-control-label" for="track-2-righthand"></label>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input"
                                                    id="track-2-background" name="track-2-background">
                                                <label class="custom-control-label" for="track-2-background"></label>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr id="track-2-options-1" hidden>
                                        <td>
                                            <input type="button" class="form-control track-preview" value="play"
                                                id="track-2-preview" />
                                        </td>
                                        <td>
                                            <select class="form-control track-sound" id="track-2-sound"
                                                name="track-2-sound">
                                                <option value="Custom">Add custom sound</option>
                                                <option value="Piano 1" selected>Piano 1</option>
                                                <option value="Piano 2">Piano 2</option>
                                                <option value="Piano 3">Piano 3</option>
                                                <option value="Violin 1">Violin 1</option>
                                                <option value="Violin 2">Violin 2</option>
                                                <option value="Trumpet">Trumpet</option>
                                            </select>
                                        </td>
                                        <td colspan="2">
                                            <div class="row">
                                                <div class="col-md-12 text-center">
                                                    <span id="track-2-volume-value">100</span>
                                                </div>
                                            </div>
                                            <div class="row range-div">
                                                <div class="col-md-2">
                                                    <span>No sound</span>
                                                </div>
                                                <div class="col-md-8">
                                                    <input type="range" class="custom-range track-volume" min="0"
                                                        max="200" step="5" value="100" id="track-2-volume"
                                                        name="track-2-volume">
                                                </div>
                                                <div class="col-md-2">
                                                    <span>200</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr id="track-2-options-2" hidden>
                                        <td colspan="4">
                                            <div class="row">
                                                <div class="col-md-12 text-center">
                                                    <span id="track-2-timebar-value">0</span>
                                                </div>
                                            </div>
                                            <div class="row range-div">
                                                <div class="col-md-2">
                                                    <span>0</span>
                                                </div>
                                                <div class="col-md-8">
                                                    <input type="range" class="custom-range track-timebar" min="0"
                                                        max="180" step="1" value="0" id="track-2-timebar">
                                                </div>
                                                <div class="col-md-2">
                                                    <span>180</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <input type="file" accept=".zip,.rar,.7z" id="custom-sound" hidden />
                </div>


                <div class="col" id="main-content-2">
                    <div class="form-group">
                        <label for="speed"><b>Speed:</b></label>
                        <div class="row">
                            <div class="col-md-12 text-center">
                                <span id="speed-value">1</span>
                            </div>
                        </div>
                        <div class="row range-div">
                            <div class="col-md-2">
                                <span>0.25</span>
                            </div>
                            <div class="col-md-8">
                                <input type="range" class="custom-range" min="0.25" max="3" step="0.25" value="1"
                                    id="speed" name="speed">
                            </div>
                            <div class="col-md-2">
                                <span>3</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="merge"><b>Merge notes faster than:</b></label>
                        <div class="row">
                            <div class="col-md-12 text-center">
                                <span id="merge-value">1/4</span>
                            </div>
                        </div>
                        <div class="row range-div">
                            <div class="col-md-2">
                                <span>Don't merge</span>
                            </div>
                            <div class="col-md-8">
                                <input type="range" class="custom-range" min="0" max="4" step="1" value="3" id="merge"
                                    name="merge">
                            </div>
                            <div class="col-md-2">
                                <span>1/2</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="no-ln"><b>Other:</b></label>
                        <div class="custom-control custom-checkbox check">
                            <input type="checkbox" class="custom-control-input" id="no-ln" name="no-ln">
                            <label class="custom-control-label" for="no-ln">No LN</label>
                        </div>
                        <div class="custom-control custom-checkbox check">
                            <input type="checkbox" class="custom-control-input" id="all-ln" name="all-ln">
                            <label class="custom-control-label" for="all-ln">All LN</label>
                        </div>
                        <div class="custom-control custom-checkbox check">
                            <input type="checkbox" class="custom-control-input" id="singletone" name="singletone">
                            <label class="custom-control-label" for="singletone">Remove MIDI volumes</label>
                        </div>
                    </div>
                </div>
            </div>


            <div class="form-group text-center" id="submit-div">
                <button type="submit" id="submit" class="btn-lg btn-primary">Convert</button>
            </div>
        </form>
    </main>


    <script>
        $(document).ready(function () {
            $("#midi").change(function () {
                if (!uploadedFileIsMidi()) {
                    $("#choose-file").text("Please choose a valid file type");
                    return;
                }

                var midiFile = $(this).prop("files")[0];
                var reader = new FileReader();

                $("#choose-midi").text(midiFile.name + " selected");

                reader.readAsArrayBuffer(midiFile);
                reader.onloadend = function () {
                    var buffer = reader.result;
                    var view = new DataView(buffer, 0, 14);
                    var trackCount = view.getUint16(10);

                    $("#tracks-table > tbody").empty();
                    for (var i = 0; i < trackCount; i++) {
                        var trackNumber = i + 1;

                        $("#tracks-table > tbody").append(`
                            <tr class="track-row" id="track-` + trackNumber + `">
                                <td>Track ` + trackNumber + `</td>
                                <td>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input"
                                            id="track-` + trackNumber + `-lefthand" name="track-` + trackNumber + `-lefthand">
                                        <label class="custom-control-label" for="track-` + trackNumber + `-lefthand"></label>
                                    </div>
                                </td>
                                <td>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input"
                                            id="track-` + trackNumber + `-righthand" name="track-` + trackNumber + `-righthand">
                                        <label class="custom-control-label" for="track-` + trackNumber + `-righthand"></label>
                                    </div>
                                </td>
                                <td>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input"
                                            id="track-` + trackNumber + `-background" name="track-` + trackNumber + `-background">
                                        <label class="custom-control-label" for="track-` + trackNumber + `-background"></label>
                                    </div>
                                </td>
                            </tr>
                            <tr id="track-` + trackNumber + `-options-1" hidden>
                                <td>
                                    <input type="button" class="form-control track-preview" value="play"
                                        id="track-` + trackNumber + `-preview" />
                                </td>
                                <td>
                                    <select class="form-control track-sound" id="track-` + trackNumber + `-sound"
                                        name="track-` + trackNumber + `-sound">
                                        <option value="Custom">Add custom sound</option>
                                        <option value="Piano 1" selected>Piano 1</option>
                                        <option value="Piano 2">Piano 2</option>
                                        <option value="Piano 3">Piano 3</option>
                                        <option value="Violin 1">Violin 1</option>
                                        <option value="Violin 2">Violin 2</option>
                                        <option value="Trumpet">Trumpet</option>
                                    </select>
                                </td>
                                <td colspan="2">
                                    <div class="row">
                                        <div class="col-md-12 text-center">
                                            <span id="track-` + trackNumber + `-volume-value">100</span>
                                        </div>
                                    </div>
                                    <div class="row range-div">
                                        <div class="col-md-2">
                                            <span>No sound</span>
                                        </div>
                                        <div class="col-md-8">
                                            <input type="range" class="custom-range track-volume" min="0"
                                                max="200" step="5" value="100" id="track-` + trackNumber + `-volume"
                                                name="track-` + trackNumber + `-volume">
                                        </div>
                                        <div class="col-md-2">
                                            <span>200</span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr id="track-` + trackNumber + `-options-2" hidden>
                                <td colspan="4">
                                    <div class="row">
                                        <div class="col-md-12 text-center">
                                            <span id="track-` + trackNumber + `-timebar-value">0</span>
                                        </div>
                                    </div>
                                    <div class="row range-div">
                                        <div class="col-md-2">
                                            <span>0</span>
                                        </div>
                                        <div class="col-md-8">
                                            <input type="range" class="custom-range track-timebar" min="0"
                                                max="180" step="1" value="0" id="track-` + trackNumber + `-timebar">
                                        </div>
                                        <div class="col-md-2">
                                            <span>180</span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `);
                    }
                }
            });

            $("#choose-midi").on("dragover", function (event) {
                event.preventDefault();
                event.stopPropagation();
            });

            $("#choose-midi").on("dragenter", function (event) {
                event.preventDefault();
                event.stopPropagation();
                $(this).text("Drop your file here");
            });

            $("#choose-midi").on("dragleave", function (event) {
                event.preventDefault();
                event.stopPropagation();
                $(this).text("Drag & Drop or click here to browse for a file");
            });

            $("#choose-midi").on("drop", function (event) {
                event.preventDefault();
                event.stopPropagation();

                var files = event.originalEvent.dataTransfer.files;
                $("#midi").prop("files", files);
                $("#midi").trigger("change");
            });


            $("#tracks-label").click(function () {
                $("#track-1").trigger("click");
            });

            $("#tracks-table").on("click", ".track-row", function() {
                var trackOptions1 = $("#" + this.id + "-options-1");
                var trackOptions2 = $("#" + this.id + "-options-2");
                console.log(this.id);

                if ($(this).hasClass("track-row-open")) {
                    $(this).removeClass("track-row-open");
                    trackOptions1.attr("hidden", true);
                    trackOptions2.attr("hidden", true);
                } else {
                    $(this).addClass("track-row-open");
                    trackOptions1.removeAttr("hidden");
                    trackOptions2.removeAttr("hidden");
                }
            });

            $("#tracks-table").on("click", ".track-preview", function() {
                alert("work in progress");
            });

            $("#tracks-table").on("change", ".track-sound", function() {
                if ($(this).val() == "Custom") {
                    alert("work in progress");
                    $("#custom-sound").trigger("click");
                }
            });

            $("#tracks-table").on("mousemove", ".track-volume", function() {
                var text;
                if (this.value == "0") {
                    text = "No sound";
                } else {
                    text = this.value;
                }
                $("#" + this.id + "-value").text(text);
            });

            $("#tracks-table").on("mousemove", ".track-timebar", function() {
                $("#" + this.id + "-value").text(this.value);
            });


            $("#speed").on("mousemove", function () {
                $("#" + this.id + "-value").text(this.value);
            });


            $("#merge").on("mousemove", function () {
                var text;
                switch (this.value) {
                    case "0":
                        text = "Don't merge"
                        break;
                    case "1":
                        text = "1/16"
                        break;
                    case "2":
                        text = "1/8"
                        break;
                    case "3":
                        text = "1/4"
                        break;
                    case "4":
                        text = "1/2"
                        break;
                }
                $("#" + this.id + "-value").text(text);
            });


            $("#no-ln").change(function () {
                if ($(this).is(":checked")) {
                    $("#all-ln").attr("disabled", true);
                } else {
                    $("#all-ln").removeAttr("disabled");
                }
            });

            $("#all-ln").change(function () {
                if ($(this).is(":checked")) {
                    $("#no-ln").attr("disabled", true);
                } else {
                    $("#no-ln").removeAttr("disabled");
                }
            });


            $("form").submit(function () {
                var trackWithHandExists = false;
                var trackCountTest = 2;
                for (var i = 0; i < trackCountTest; i++) {
                    if ($("#track-" + (i + 1) + "-lefthand").is(":checked")) {
                        trackWithHandExists = true;
                        break;
                    }
                    if ($("#track-" + (i + 1) + "-righthand").is(":checked")) {
                        trackWithHandExists = true;
                        break;
                    }
                }

                if (!uploadedFileIsMidi()) {
                    alert("Please upload a valid midi file first!");
                } else if (!trackWithHandExists) {
                    alert("Please choose at least one track to play with!");
                } else {
                    return;
                }

                event.preventDefault();
            });
        });
    </script>
</body>

</html>