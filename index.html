<!DOCTYPE html>
<html lang="en">

<head>
    <title>MIDItoOSU</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/style.css" />

    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/functions.js"></script>
</head>


<body>
    <header>
        <div id="header-content">
            <h1>MIDItoOSU</h1>
            <p>A MIDI to osu!mania 10k beatmap converter</p>
        </div>
    </header>


    <main>
        <form action="php/convert.php" method="post">
            <div class="row">
                <div class="col" id="main-content-1">
                    <div class="form-group">
                        <label for="midi" title="Upload a MIDI file. This file will later be converted to a beatmap."><b>MIDI file:</b></label>
                        <label for="midi" class="form-control" id="choose-midi">
                            Drag & Drop or click here to browse for a file
                        </label>
                        <input type="file" accept=".mid" id="midi" name="midi" hidden />
                    </div>

                    <div class="form-group">
                        <label id="tracks-label" title="The tracks inside the file. Click on one to see more options."><b>Tracks:</b></label>
                        <div id="tracks">
                            <table class="table table-borderless" id="tracks-table">
                                <thead>
                                    <tr>
                                        <th title="The name of the track. This could be the name given by the file, the instrument or just 'Track x' depending on the data in the file.">Name</th>
                                        <th title="Check this to add the notes in this track to the first 5 columns of the beatmap.">Lefthand</th>
                                        <th title="Check this to add the notes in this track to the last 5 columns of the beatmap.">Righthand</th>
                                        <th title="Check this to add this track to the background music. You will not have to press any buttons.">Background</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="track-row" id="track-1">
                                        <td>Track 1</td>
                                        <td>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input"
                                                    id="track-1-lefthand" name="track-1-lefthand">
                                                <label class="custom-control-label" for="track-1-lefthand"></label>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input"
                                                    id="track-1-righthand" name="track-1-righthand">
                                                <label class="custom-control-label" for="track-1-righthand"></label>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input"
                                                    id="track-1-background" name="track-1-background">
                                                <label class="custom-control-label" for="track-1-background"></label>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr id="track-1-options-1" hidden>
                                        <td>
                                            <input type="button" class="form-control track-preview" value="play"
                                                id="track-1-preview" title="Start playing, pause or resume this track with the settings on the page."/>
                                        </td>
                                        <td>
                                            <select class="form-control track-sound" id="track-1-sound"
                                                name="track-1-sound" title="Change the sound of the notes in this track. Select 'Add custom sound' to browse for and add your own sound. Your sound files must be inside one of the following archives: .zip, .rar, .7z and must have the following structure: WORK IN PROGRESS">
                                                <option value="Custom">Add custom sound</option>
                                                <option value="Piano 1" selected>Piano 1</option>
                                                <option value="Piano 2">Piano 2</option>
                                                <option value="Piano 3">Piano 3</option>
                                                <option value="Violin 1">Violin 1</option>
                                                <option value="Violin 2">Violin 2</option>
                                                <option value="Trumpet">Trumpet</option>
                                            </select>
                                        </td>
                                        <td colspan="2" title="The volume difference of the track. This will not make all notes sound equally loud but rather make them x times louder/more silent than they are in the file. To make every note sound equally loud, check the 'Remove MIDI volumes' checkbox on the right. To not use sound for this track, slide all the way to the left.">
                                            <div class="row">
                                                <div class="col-md-12 text-center">
                                                    <span id="track-1-volume-value">100</span>
                                                </div>
                                            </div>
                                            <div class="row range-div">
                                                <div class="col-md-2">
                                                    <span>No sound</span>
                                                </div>
                                                <div class="col-md-8">
                                                    <input type="range" class="custom-range track-volume" min="0"
                                                        max="200" step="5" value="100" id="track-1-volume"
                                                        name="track-1-volume">
                                                </div>
                                                <div class="col-md-2">
                                                    <span>200</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr id="track-1-options-2" hidden>
                                        <td colspan="4" title="The time bar of the track being played. See this as one of those bars under a video or music player.">
                                            <div class="row">
                                                <div class="col-md-12 text-center">
                                                    <span id="track-1-timebar-value">0</span>
                                                </div>
                                            </div>
                                            <div class="row range-div">
                                                <div class="col-md-2">
                                                    <span>0</span>
                                                </div>
                                                <div class="col-md-8">
                                                    <input type="range" class="custom-range track-timebar" min="0"
                                                        max="180" step="1" value="0" id="track-1-timebar">
                                                </div>
                                                <div class="col-md-2">
                                                    <span>180</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <input type="file" accept=".zip,.rar,.7z" id="custom-sound" hidden />
                </div>


                <div class="col" id="main-content-2">
                    <div class="form-group">
                        <label for="speed" title="The speed of the beatmap. See this as making it x times slower/faster."><b>Speed:</b></label>
                        <div class="row">
                            <div class="col-md-12 text-center">
                                <span id="speed-value">1</span>
                            </div>
                        </div>
                        <div class="row range-div">
                            <div class="col-md-2">
                                <span>0.25</span>
                            </div>
                            <div class="col-md-8">
                                <input type="range" class="custom-range" min="0.25" max="3" step="0.25" value="1"
                                    id="speed" name="speed">
                            </div>
                            <div class="col-md-2">
                                <span>3</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="merge" title="The interval at which notes will be put on the same spot/time. Slide all the way left to disable this feature."><b>Merge notes faster than:</b></label>
                        <div class="row">
                            <div class="col-md-12 text-center">
                                <span id="merge-value">1/8</span>
                            </div>
                        </div>
                        <div class="row range-div">
                            <div class="col-md-2">
                                <span>Don't merge</span>
                            </div>
                            <div class="col-md-8">
                                <input type="range" class="custom-range" min="0" max="4" step="1" value="2" id="merge"
                                    name="merge">
                            </div>
                            <div class="col-md-2">
                                <span>1/2</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="ln" title="How notes are handled. Hover over the specific options to learn more."><b>Long Notes</b></label>
                        <div class="row">
                            <div class="col-md-2"></div>
                            <div class="col-md-8" style="width: 80%;">
                                <input type="range" class="custom-range" min="0" max="3" step="1" value="1" id="ln"
                                    name="ln">
                            </div>
                            <div class="col-md-2"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-1"></div>
                            <div class="col text-center" title="Makes every note a short note.">
                                <span>No LN</span>
                            </div>
                            <div class="col text-center" title="Looks at the length of the note in the file and decides if it should be a long note or a short note.">
                                <span>Default</span>
                            </div>
                            <div class="col text-center" title="Makes every note the length it is in the file.">
                                <span>All LN 1</span>
                            </div>
                            <div class="col text-center" title="Makes every note the length it is in the file and extends it untill the next note. This way you will always be pressing at least one button.">
                                <span>All LN 2</span>
                            </div>
                            <div class="col-md-1"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="singletone" title="Ignores the volume values in the file making every note in a track the same volume. The volume of different tracks can still vary by changing their volume slide."><b>Remove MIDI volumes:</b></label>
                        <div class="custom-control custom-checkbox" id="singletone-div">
                            <input type="checkbox" class="custom-control-input" id="singletone" name="singletone">
                            <label class="custom-control-label" for="singletone"></label>
                        </div>
                    </div>
                </div>
            </div>


            <div class="form-group text-center" id="submit-div">
                <button type="submit" id="submit" class="btn-lg btn-primary" title="Checks if you have done everything to start converting. If you have not, a popup will show telling you what you still have to do. If you have, it will start the converting process.">Convert</button>
            </div>
        </form>
    </main>


    <script>
        $(document).ready(function () {
            $("#midi").change(function () {
                if (!uploadedFileIsMidi()) {
                    $("#choose-file").text("Please choose a valid file type");
                    return;
                }

                var midiFile = $(this).prop("files")[0];
                var reader = new FileReader();

                $("#choose-midi").text(midiFile.name + " selected");

                reader.readAsArrayBuffer(midiFile);
                reader.onloadend = function () {
                    var buffer = reader.result;
                    var view = new DataView(buffer, 0, 14);
                    var trackCount = view.getUint16(10);

                    $("#tracks-table > tbody").empty();
                    for (var i = 0; i < trackCount; i++) {
                        var trackNumber = i + 1;

                        $("#tracks-table > tbody").append(`
                            <tr class="track-row" id="track-` + trackNumber + `">
                                <td>Track ` + trackNumber + `</td>
                                <td>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input"
                                            id="track-` + trackNumber + `-lefthand" name="track-` + trackNumber + `-lefthand">
                                        <label class="custom-control-label" for="track-` + trackNumber + `-lefthand"></label>
                                    </div>
                                </td>
                                <td>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input"
                                            id="track-` + trackNumber + `-righthand" name="track-` + trackNumber + `-righthand">
                                        <label class="custom-control-label" for="track-` + trackNumber + `-righthand"></label>
                                    </div>
                                </td>
                                <td>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input"
                                            id="track-` + trackNumber + `-background" name="track-` + trackNumber + `-background">
                                        <label class="custom-control-label" for="track-` + trackNumber + `-background"></label>
                                    </div>
                                </td>
                            </tr>
                            <tr id="track-` + trackNumber + `-options-1" hidden>
                                <td>
                                    <input type="button" class="form-control track-preview" value="play"
                                        id="track-` + trackNumber + `-preview" title="Start playing, pause or resume this track with the settings on the page."/>
                                </td>
                                <td>
                                    <select class="form-control track-sound" id="track-` + trackNumber + `-sound"
                                        name="track-` + trackNumber + `-sound" title="Change the sound of the notes in this track. Select 'Add custom sound' to browse for and add your own sound. Your sound files must be inside one of the following archives: .zip, .rar, .7z and must have the following structure: WORK IN PROGRESS">
                                        <option value="Custom">Add custom sound</option>
                                        <option value="Piano 1" selected>Piano 1</option>
                                        <option value="Piano 2">Piano 2</option>
                                        <option value="Piano 3">Piano 3</option>
                                        <option value="Violin 1">Violin 1</option>
                                        <option value="Violin 2">Violin 2</option>
                                        <option value="Trumpet">Trumpet</option>
                                    </select>
                                </td>
                                <td colspan="2" title="The volume difference of the track. This will not make all notes sound equally loud but rather make them x times louder/more silent than they are in the file. To make every note sound equally loud, check the 'Remove MIDI volumes' checkbox on the right. To not use sound for this track, slide all the way to the left.">
                                    <div class="row">
                                        <div class="col-md-12 text-center">
                                            <span id="track-` + trackNumber + `-volume-value">100</span>
                                        </div>
                                    </div>
                                    <div class="row range-div">
                                        <div class="col-md-2">
                                            <span>No sound</span>
                                        </div>
                                        <div class="col-md-8">
                                            <input type="range" class="custom-range track-volume" min="0"
                                                max="200" step="5" value="100" id="track-` + trackNumber + `-volume"
                                                name="track-` + trackNumber + `-volume">
                                        </div>
                                        <div class="col-md-2">
                                            <span>200</span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr id="track-` + trackNumber + `-options-2" hidden>
                                <td colspan="4" title="The time bar of the track being played. See this as one of those bars under a video or music player.">
                                    <div class="row">
                                        <div class="col-md-12 text-center">
                                            <span id="track-` + trackNumber + `-timebar-value">0</span>
                                        </div>
                                    </div>
                                    <div class="row range-div">
                                        <div class="col-md-2">
                                            <span>0</span>
                                        </div>
                                        <div class="col-md-8">
                                            <input type="range" class="custom-range track-timebar" min="0"
                                                max="180" step="1" value="0" id="track-` + trackNumber + `-timebar">
                                        </div>
                                        <div class="col-md-2">
                                            <span>180</span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `);
                    }
                }
            });

            $("#choose-midi").on("dragover", function (event) {
                event.preventDefault();
                event.stopPropagation();
            });

            $("#choose-midi").on("dragenter", function (event) {
                event.preventDefault();
                event.stopPropagation();
                $(this).text("Drop your file here");
            });

            $("#choose-midi").on("dragleave", function (event) {
                event.preventDefault();
                event.stopPropagation();
                $(this).text("Drag & Drop or click here to browse for a file");
            });

            $("#choose-midi").on("drop", function (event) {
                event.preventDefault();
                event.stopPropagation();

                var files = event.originalEvent.dataTransfer.files;
                $("#midi").prop("files", files);
                $("#midi").trigger("change");
            });


            $("#tracks-label").click(function () {
                $("#track-1").trigger("click");
            });

            $("#tracks-table").on("click", ".track-row", function() {
                var trackOptions1 = $("#" + this.id + "-options-1");
                var trackOptions2 = $("#" + this.id + "-options-2");
                console.log(this.id);

                if ($(this).hasClass("track-row-open")) {
                    $(this).removeClass("track-row-open");
                    trackOptions1.attr("hidden", true);
                    trackOptions2.attr("hidden", true);
                } else {
                    $(this).addClass("track-row-open");
                    trackOptions1.removeAttr("hidden");
                    trackOptions2.removeAttr("hidden");
                }
            });

            $("#tracks-table").on("click", ".track-preview", function() {
                alert("work in progress");
            });

            $("#tracks-table").on("change", ".track-sound", function() {
                if ($(this).val() == "Custom") {
                    alert("work in progress");
                    $("#custom-sound").trigger("click");
                }
            });

            $("#tracks-table").on("mousemove", ".track-volume", function() {
                var text;
                if (this.value == "0") {
                    text = "No sound";
                } else {
                    text = this.value;
                }
                $("#" + this.id + "-value").text(text);
            });

            $("#tracks-table").on("mousemove", ".track-timebar", function() {
                $("#" + this.id + "-value").text(this.value);
            });


            $("#speed").on("mousemove", function () {
                $("#" + this.id + "-value").text(this.value);
            });


            $("#merge").on("mousemove", function () {
                var text;
                switch (this.value) {
                    case "0":
                        text = "Don't merge"
                        break;
                    case "1":
                        text = "1/16"
                        break;
                    case "2":
                        text = "1/8"
                        break;
                    case "3":
                        text = "1/4"
                        break;
                    case "4":
                        text = "1/2"
                        break;
                }
                $("#" + this.id + "-value").text(text);
            });


            $("#no-ln").change(function () {
                if ($(this).is(":checked")) {
                    $("#all-ln").attr("disabled", true);
                } else {
                    $("#all-ln").removeAttr("disabled");
                }
            });

            $("#all-ln").change(function () {
                if ($(this).is(":checked")) {
                    $("#no-ln").attr("disabled", true);
                } else {
                    $("#no-ln").removeAttr("disabled");
                }
            });


            $("form").submit(function () {
                var trackWithHandExists = false;
                var trackCountTest = 2;
                for (var i = 0; i < trackCountTest; i++) {
                    if ($("#track-" + (i + 1) + "-lefthand").is(":checked")) {
                        trackWithHandExists = true;
                        break;
                    }
                    if ($("#track-" + (i + 1) + "-righthand").is(":checked")) {
                        trackWithHandExists = true;
                        break;
                    }
                }

                if (!uploadedFileIsMidi()) {
                    alert("Please upload a valid midi file first!");
                } else if (!trackWithHandExists) {
                    alert("Please choose at least one track to play with!");
                } else {
                    return;
                }

                event.preventDefault();
            });
        });
    </script>
</body>

</html>